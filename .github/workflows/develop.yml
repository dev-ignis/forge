name: Develop CI

on:
  push:
    branches: [develop]
    paths-ignore: ['docs/**', 'plans/**', '*.md', '.github/workflows/deploy.yml']
  pull_request:
    branches: [develop]
    paths-ignore: ['docs/**', 'plans/**', '*.md', '.github/workflows/deploy.yml']
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish beta version to npm'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Comprehensive validation for PRs
  lint:
    name: Lint (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node & Install
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ matrix.node-version }}

      - name: Run linter
        run: npm run lint

  typecheck:
    name: Type Check (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node & Install
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ matrix.node-version }}

      - name: Build workspace packages
        run: |
          npm run build:types
          npm run build --workspace=packages/forge-react

      - name: Type check
        run: npm run type-check

  test:
    name: Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node & Install
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ matrix.node-version }}

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: matrix.node-version == '20.x'
        with:
          name: coverage-develop
          path: coverage/
          retention-days: 3

  # Lightweight smoke test for pushes to develop or manual publish
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.publish == true)
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node & Install
        uses: ./.github/actions/setup-node

      - name: Security audit
        run: |
          npm audit --audit-level=moderate || {
            echo "⚠️ Security vulnerabilities detected"
            npm audit
            exit 1
          }

      - name: Quick build validation
        run: npm run build

      - name: Basic AI validation
        run: npm run validate:ai

  # Build job (runs after quality gates pass for PRs)
  build:
    name: Build & Validate
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node & Install
        uses: ./.github/actions/setup-node

      - name: Build packages
        run: npm run build

      - name: Validate AI Manifest
        run: npm run validate:ai

  # Manual publish job (beta releases from develop)
  publish:
    name: Publish Beta
    runs-on: ubuntu-latest
    needs: [smoke-test]
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.publish == true }}
    environment: npm-publish
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        
      - name: Setup Node & Install
        uses: ./.github/actions/setup-node

      - name: Build packages
        run: npm run build

      - name: Configure npm authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      - name: Publish beta to npm
        run: |
          echo "🔍 DEBUG: Starting Changesets beta publishing process..."

          # Enter beta pre-release mode if not already in it
          if [ ! -f .changeset/pre.json ]; then
            echo "Entering beta pre-release mode..."
            npx changeset pre enter beta
          fi

          # Version packages using Changesets
          echo "Versioning packages with Changesets..."
          npx changeset version

          # Update lockfile with new versions (preserve lock file integrity)
          echo "Updating package-lock.json with new versions..."
          npm install --package-lock-only

          # Rebuild packages with correct versions
          npm run build

          # Publish all packages using Changesets (pre-mode automatically uses beta tag)
          echo "Publishing packages with beta tag..."
          npx changeset publish

          echo "✅ Published all packages with beta versions using Changesets"